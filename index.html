<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combinador de Imágenes con IA</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🪄</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        // PayPal SDK will be loaded dynamically based on environment
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(-45deg, #0d0221, #0c164f, #1e1b4b, #4338ca);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .styled-button {
            transition: all 0.3s ease-in-out;
            border: 2px solid;
            font-weight: 600;
            background-color: transparent;
        }
        .styled-button:hover:not(:disabled) {
            transform: scale(1.05) translateY(-2px);
            color: #ffffff;
        }
        .styled-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            border-color: #6366f1; /* indigo-500 */
            color: #818cf8; /* indigo-400 */
            box-shadow: 0 0 8px rgba(99, 102, 241, 0.4);
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #6366f1;
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.7);
        }
         .btn-secondary {
            border-color: #3b82f6; /* blue-500 */
            color: #60a5fa; /* blue-400 */
             box-shadow: 0 0 8px rgba(59, 130, 246, 0.4);
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #3b82f6;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.7);
        }

        .loader {
            border: 4px solid #374151;
            border-top: 4px solid #6366f1; /* indigo-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .upload-box {
            background-color: rgba(17, 24, 39, 0.5);
            border: 2px dashed #4f46e5; /* indigo-600 */
            transition: all 0.3s ease;
            box-shadow: 0 0 8px rgba(79, 70, 229, 0.3);
        }
        .upload-box:hover {
            border-color: #818cf8; /* indigo-400 */
            box-shadow: 0 0 12px rgba(129, 140, 248, 0.5);
            transform: scale(1.05);
        }
        .upload-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            border-radius: 0.5rem;
        }
        .upload-box .icon, .upload-box .text { z-index: 5; }
        .upload-box.has-image .icon, .upload-box.has-image .text { opacity: 0; }
        
        .result-container {
             background-color: rgba(17, 24, 39, 0.5);
             border-color: rgba(99, 102, 241, 0.4);
             box-shadow: 0 0 15px rgba(99, 102, 241, 0.2);
        }

        .gemini-icon-spin {
            animation: spin 1s linear infinite;
        }
        
        .modal-overlay {
            background-color: rgba(0,0,0,0.7);
            z-index: 999;
        }
        .modal-content {
            background-color: #1e1b4b;
            box-shadow: 0 0 25px rgba(99, 102, 241, 0.5);
        }

        /* Plan Status Styles */
        #plan-status {
            background: rgba(17, 24, 39, 0.7);
            border: 1px solid rgba(99, 102, 241, 0.3);
        }
        
        .plan-free {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .plan-premium {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
        }
        
        .usage-warning {
            color: #f59e0b !important;
        }
        
        .usage-limit {
            color: #ef4444 !important;
        }

        #camera-view video {
            transform: scaleX(-1);
        }

        #mask-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 0, 0, 0.2); /* Fondo rojo semitransparente para visualización */
            cursor: crosshair;
            pointer-events: auto;
            z-index: 5;
        }

        .drawing-prompt-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(17, 24, 39, 0.95);
            border: 2px solid #6366f1;
            border-radius: 12px;
            padding: 20px;
            z-index: 1000;
            max-width: 400px;
            width: 90%;
            backdrop-filter: blur(10px);
        }

        #floating-image-container {
            position: absolute;
            touch-action: none; /* Required for interact.js */
            user-select: none;
            box-sizing: border-box;
            border: 2px dashed rgba(99, 102, 241, 0.8);
            border-radius: 4px;
            min-width: 50px;
            min-height: 50px;
            max-width: 90%;
            max-height: 90%;
            cursor: move;
            transition: border-color 0.2s ease;
        }
        #floating-image-container:hover {
            border-color: rgba(99, 102, 241, 1);
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.3);
        }
        #floating-image-container.active {
            border-color: rgba(34, 197, 94, 0.8);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.4);
        }
        #floating-image-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            pointer-events: none;
            border-radius: 2px;
        }
        .interaction-handle {
            position: absolute;
            width: 24px;
            height: 24px;
            background-color: #6366f1;
            border: 3px solid white;
            border-radius: 50%;
            z-index: 15;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
        }
        .interaction-handle:hover {
            background-color: #4f46e5;
            transform: scale(1.1);
        }
        #resize-handle {
            bottom: -12px;
            right: -12px;
            cursor: se-resize;
        }
        #rotate-handle {
            top: -12px;
            right: -12px;
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>') 16 16, auto;
        }
        /* Scale handle for mobile */
        #scale-handle {
            bottom: -12px;
            left: -12px;
            cursor: nw-resize;
            background-color: #10b981;
        }
        /* Mobile touch improvements */
        @media (max-width: 768px) {
            .interaction-handle {
                width: 32px;
                height: 32px;
            }
            #resize-handle, #rotate-handle, #scale-handle {
                bottom: -16px;
                right: -16px;
            }
            #scale-handle {
                bottom: -16px;
                left: -16px;
            }
            #rotate-handle {
                top: -16px;
                right: -16px;
            }
        }
        /* Carousel Styles */
        .carousel {
            overflow-x: scroll;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
        }
        .carousel::-webkit-scrollbar {
            display: none; /* Safari and Chrome */
        }
        .carousel-track {
            display: flex;
            transition: transform 0.3s ease-in-out;
        }
        .carousel-slide {
            flex: 0 0 100%;
            width: 100%;
            scroll-snap-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .carousel-btn {
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0,0,0,0.4);
            border-radius: 50%;
            z-index: 10;
        }
        .carousel-btn:hover {
             background-color: rgba(0,0,0,0.7);
        }

        /* Mobile Optimizations */
        @media (max-width: 640px) {
            body {
                padding: 8px;
            }
            
            .container {
                max-width: 100%;
                padding: 0 8px;
            }
            
            /* Compact buttons for mobile */
            .styled-button {
                font-size: 11px;
                padding: 6px 12px;
                min-height: 32px;
            }
            
            /* Upload slots optimization */
            .upload-box {
                min-height: 80px;
                font-size: 12px;
            }
            
            /* Input optimization */
            input, textarea, select {
                font-size: 16px; /* Prevents zoom on iOS */
                min-height: 44px; /* iOS touch target */
            }
            
            /* Modal optimization */
            .modal-content {
                margin: 10px;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            /* Result container mobile */
            .result-container {
                min-height: 250px;
                margin-bottom: 16px;
            }
            
            /* Carousel buttons mobile */
            .carousel-btn {
                width: 36px;
                height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* Save actions mobile */
            #save-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            #save-actions .flex {
                width: 100%;
                justify-content: center;
            }
        }

        /* Extra small devices */
        @media (max-width: 375px) {
            h1 {
                font-size: 18px !important;
            }
            
            .styled-button {
                font-size: 10px;
                padding: 4px 8px;
            }
            
            .upload-box {
                min-height: 70px;
                font-size: 11px;
            }
        }

        /* Touch-specific styles */
        @media (hover: none) and (pointer: coarse) {
            .styled-button:hover {
                transform: none;
            }
            
            .styled-button:active {
                transform: scale(0.95);
            }
            
            .upload-box:hover {
                transform: none;
            }
            
            .upload-box:active {
                transform: scale(0.98);
            }
        }
    </style>
</head>
<body class="text-white flex items-center justify-center min-h-screen p-4">
    <div class="container mx-auto max-w-3xl text-center w-full px-2 sm:px-4">
        
        <!-- Plan Status Header -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-2">
            <div class="flex items-center">
                <h1 class="text-xl sm:text-2xl md:text-3xl font-bold bg-gradient-to-r from-blue-400 to-indigo-500 text-transparent bg-clip-text text-center sm:text-left">
                    Combinador de Imágenes IA
                </h1>
            </div>
            <div class="flex items-center gap-2 sm:gap-3 flex-wrap justify-center">
                <div id="plan-status" class="flex items-center gap-1 sm:gap-2 px-2 sm:px-3 py-1 rounded-full text-xs font-medium">
                    <span id="plan-badge" class="px-1 sm:px-2 py-1 rounded-full text-xs">GRATIS</span>
                    <span id="usage-count" class="text-gray-300 text-xs">0/5 usos</span>
                </div>
                <button id="upgrade-btn" class="hidden px-2 sm:px-3 py-1 bg-gradient-to-r from-purple-500 to-pink-500 text-white text-xs font-medium rounded-full hover:from-purple-600 hover:to-pink-600 transition whitespace-nowrap">
                    ⚡ PREMIUM
                </button>
            </div>
        </div>
        <p class="text-gray-400 text-sm mb-8">
            Sube hasta 3 imágenes y describe cómo combinarlas.
        </p>

        <!-- Image upload section -->
        <div id="upload-container" class="flex justify-center items-center gap-2 sm:gap-4 mb-6">
             <!-- Slots are generated by JS now -->
        </div>

        <!-- Input section -->
        <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 w-full mb-6">
            <div class="relative flex-grow">
                <input type="text" id="prompt-input" class="w-full pl-3 pr-12 py-3 sm:py-2 text-sm sm:text-xs bg-gray-800/50 border border-indigo-500/50 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none transition placeholder-gray-500" placeholder="Describe tu idea...">
                <button id="rewrite-btn" class="absolute inset-y-0 right-0 flex items-center pr-3 group" title="Generar idea de prompt con IA">
                    <svg id="gemini-icon" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 sm:w-5 sm:h-5 text-gray-400 group-hover:text-indigo-400 transition" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M15.5 2.5a.5.5 0 00-.5-.5h-10a.5.5 0 00-.5.5v10a.5.5 0 00.5.5h10a.5.5 0 00.5-.5v-10zM5 4a1 1 0 00-1 1v10a1 1 0 001 1h10a1 1 0 001-1V5a1 1 0 00-1-1H5z" clip-rule="evenodd" />
                        <path d="M8 6a1 1 0 100 2 1 1 0 000-2zM6 10a1 1 0 112 0 1 1 0 01-2 0zm4 0a1 1 0 112 0 1 1 0 01-2 0zm2 4a1 1 0 100-2 1 1 0 000 2zm-4-4a1 1 0 112 0 1 1 0 01-2 0z" />
                    </svg>
                </button>
            </div>
            <button id="generate-btn" class="styled-button btn-primary py-3 px-4 sm:py-1 sm:px-3 text-sm sm:text-xs rounded-lg sm:rounded-md whitespace-nowrap w-full sm:w-auto">
                Combinar
            </button>
        </div>
        
        <!-- Edit Section -->
        <div id="edit-section" class="hidden w-full mb-6">
            <div class="relative flex flex-col gap-2">
                <input type="text" id="edit-prompt-input" class="w-full pl-3 py-3 sm:py-2 text-sm sm:text-xs bg-gray-800/50 border border-indigo-500/50 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none transition placeholder-gray-500" placeholder="Edita la imagen actual. Ej: Añade un cielo estrellado...">
                <div class="flex gap-2">
                    <button id="edit-btn" class="styled-button btn-primary py-3 px-4 sm:py-1 sm:px-4 text-sm sm:text-xs rounded-lg whitespace-nowrap flex-1">Editar</button>
                    <button id="inpaint-cancel-btn" class="hidden styled-button btn-primary py-3 px-4 sm:py-1 sm:px-4 text-sm sm:text-xs rounded-lg whitespace-nowrap bg-gray-600 border-gray-500 text-gray-300 hover:bg-gray-700 flex-1">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Overlay Section -->
        <div id="overlay-section" class="hidden w-full mb-6 p-3 border border-indigo-500/30 rounded-lg bg-gray-900/20">
             <p class="text-indigo-300 mb-2 text-xs sm:text-xs text-left">Añade una imagen superpuesta. Arrástrala, redimensiónala y rótala sobre la imagen de fondo.</p>
            <div class="flex flex-col gap-2">
                <button id="upload-overlay-btn" class="styled-button btn-secondary py-3 px-4 sm:py-1 sm:px-3 text-sm sm:text-xs rounded-lg sm:rounded-md whitespace-nowrap w-full">Cargar Imagen Flotante</button>
                <input type="file" id="overlay-image-upload" class="hidden" accept="image/*">
                <div class="relative flex-grow">
                    <input type="text" id="overlay-prompt-input" class="w-full pl-3 pr-3 py-3 sm:py-2 text-sm sm:text-xs bg-gray-800/50 border border-indigo-500/50 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none transition placeholder-gray-500" placeholder="Ej: un fantasma transparente sobre el bosque...">
                </div>
                <button id="implement-overlay-btn" class="styled-button btn-primary py-3 px-4 sm:py-1 sm:px-3 text-sm sm:text-xs rounded-lg sm:rounded-md whitespace-nowrap flex items-center justify-center gap-1.5 w-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-3.5 sm:w-3.5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zm0 4a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zm0 4a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1z" /></svg>
                    <span>Implementar</span>
                </button>
            </div>
        </div>

        <!-- Save Actions Section -->
        <div id="save-actions" class="hidden w-full flex flex-col sm:flex-row justify-between items-stretch sm:items-center gap-2 mb-4">
            <div class="flex items-center justify-center gap-1 p-2 sm:p-1 border border-indigo-500/50 rounded-lg bg-gray-800/30 order-2 sm:order-1">
                <button id="tool-pencil" class="tool-btn p-2 sm:p-1 rounded-md hover:bg-indigo-500/50" title="Lápiz - Dibujar área a editar">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-4 sm:w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                </button>
                <button id="inpaint-cancel-btn" class="hidden tool-btn p-2 sm:p-1 rounded-md bg-red-500/80 hover:bg-red-500 text-white" title="Cancelar modo lápiz (ESC)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-4 sm:w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                </button>
            </div>
            <div class="flex gap-2 order-1 sm:order-2">
                <button id="save-btn" class="styled-button btn-secondary py-3 px-4 sm:py-1 sm:px-3 text-sm sm:text-xs rounded-lg sm:rounded-md whitespace-nowrap bg-blue-500 text-white hover:bg-blue-600 flex-1 sm:flex-none">Guardar</button>
                <button id="save-album-btn" class="styled-button btn-primary py-3 px-4 sm:py-1 sm:px-3 text-sm sm:text-xs rounded-lg sm:rounded-md whitespace-nowrap bg-indigo-500 text-white hover:bg-indigo-600 flex-1 sm:flex-none">Guardar Álbum</button>
            </div>
        </div>

        <!-- Result section with Carousel -->
        <div id="result-container" class="result-container relative w-full border rounded-lg p-2 min-h-[300px] flex items-center justify-center shadow-inner">
             <button id="prev-btn" class="carousel-btn hidden absolute left-2 p-2 text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
            <div id="carousel" class="carousel w-full h-full">
                <canvas id="mask-canvas" class="hidden"></canvas>
                <div id="carousel-track" class="carousel-track h-full">
                    <div id="placeholder-slide" class="carousel-slide">
                         <div id="placeholder" class="text-gray-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-image-alt mb-3 inline-block" viewBox="0 0 16 16"><path d="M7 2.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0m4.225 4.053a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L.002 13V3a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-1.172a2.999 2.999 0 0 1-2.121-.879l-4.144-4.143a.5.5 0 0 0-.707 0L2.95 11.536l2.614-2.354a.5.5 0 0 0 .63-.062l2.66 1.772 3.71-3.71a.5.5 0 0 0 .093-.577z"/></svg>
                            <p>Tu imagen combinada aparecerá aquí.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div id="floating-image-container" class="hidden">
                <img id="floating-image" src="" alt="Imagen flotante">
                <div id="resize-handle" class="interaction-handle" title="Redimensionar"></div>
                <div id="rotate-handle" class="interaction-handle" title="Rotar"></div>
                <div id="scale-handle" class="interaction-handle" title="Escalar"></div>
            </div>
             <button id="next-btn" class="carousel-btn hidden absolute right-2 p-2 text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
            <div id="loader" class="hidden loader absolute"></div>
            <div id="error-message" class="hidden text-red-400 absolute"></div>
        </div>

    </div>

    <!-- Modals -->
    <div id="source-modal" class="modal-overlay hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="modal-content p-4 sm:p-6 rounded-lg text-center w-full max-w-sm">
            <h3 class="text-lg font-medium mb-4">Seleccionar Fuente</h3>
            <div class="flex flex-col sm:flex-row gap-3">
                <button id="from-camera-btn" class="styled-button btn-primary flex-1 py-3 sm:py-2 px-4 rounded-lg text-sm">Tomar Foto</button>
                <button id="from-file-btn" class="styled-button btn-secondary flex-1 py-3 sm:py-2 px-4 rounded-lg text-sm">Elegir Archivo</button>
            </div>
            <button id="close-source-modal-btn" class="mt-4 py-2 px-4 text-gray-400 hover:text-white">Cancelar</button>
        </div>
    </div>
    <div id="camera-modal" class="modal-overlay hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="modal-content p-4 rounded-lg text-center w-full max-w-lg">
            <video id="camera-view" class="w-full rounded-md mb-4" autoplay playsinline></video>
            <canvas id="camera-canvas" class="hidden"></canvas>
            <button id="capture-btn" class="styled-button btn-primary w-full py-3 sm:py-2 px-4 rounded-lg mb-2 text-sm">Capturar</button>
            <button id="close-camera-modal-btn" class="py-2 px-4 text-gray-400 hover:text-white">Cerrar</button>
        </div>
    </div>

    <!-- Drawing Area Prompt Modal -->
    <div id="drawing-prompt-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-4 sm:p-6 max-w-md w-full border border-indigo-500 max-h-[80vh] overflow-y-auto">
            <h3 class="text-lg font-semibold mb-2 text-center text-white">¿Qué cambio quieres hacer?</h3>
            <p class="text-xs text-gray-400 mb-4 text-center">El cambio se aplicará exactamente en el área que dibujaste</p>
            <textarea id="drawing-prompt-textarea" 
                     class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white resize-none focus:border-indigo-400 focus:outline-none text-sm" 
                     rows="4" 
                     placeholder="Ej: cambiar el color a azul, agregar una flor, eliminar este objeto, hacer más brillante..."></textarea>
            <div class="flex flex-col sm:flex-row gap-3 mt-4">
                <button id="drawing-prompt-cancel" class="flex-1 btn-secondary styled-button px-4 py-3 sm:py-2 rounded-lg text-sm">Cancelar</button>
                <button id="drawing-prompt-apply" class="flex-1 btn-primary styled-button px-4 py-3 sm:py-2 rounded-lg text-sm">Aplicar Cambio</button>
            </div>
        </div>
    </div>

    <!-- Pricing Modal -->
    <div id="pricing-modal" class="modal-overlay hidden fixed inset-0 flex items-center justify-center z-50 p-4">
        <div class="modal-content rounded-lg p-4 sm:p-6 max-w-md w-full text-white max-h-[90vh] overflow-y-auto">
            <div class="text-center">
                <h2 class="text-2xl font-bold mb-2 bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                    🚀 Desbloquea el Poder Completo
                </h2>
                <p class="text-gray-300 text-sm mb-6">Lleva tu creatividad al siguiente nivel</p>
            </div>

            <div class="space-y-4 mb-6">
                <!-- Plan Gratuito -->
                <div class="border border-gray-600 rounded-lg p-4 bg-gray-800/50">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-semibold text-green-400">Plan Gratuito</h3>
                        <span class="text-green-400 font-bold">$0</span>
                    </div>
                    <ul class="text-xs text-gray-300 space-y-1">
                        <li>✅ 5 generaciones por día</li>
                        <li>✅ Resolución estándar</li>
                        <li>✅ Todas las herramientas básicas</li>
                        <li>❌ Sin anuncios</li>
                    </ul>
                </div>

                <!-- Plan Premium -->
                <div class="border-2 border-purple-500 rounded-lg p-4 bg-gradient-to-br from-purple-900/30 to-pink-900/30 relative">
                    <div class="absolute -top-2 left-1/2 transform -translate-x-1/2">
                        <span class="bg-gradient-to-r from-purple-500 to-pink-500 text-white text-xs px-3 py-1 rounded-full font-bold">
                            ⚡ POPULAR
                        </span>
                    </div>
                    <div class="flex items-center justify-between mb-2 mt-2">
                        <h3 class="font-semibold text-purple-400">Plan Premium</h3>
                        <div class="text-right">
                            <span class="text-purple-400 font-bold text-xl">$9.99</span>
                            <span class="text-gray-400 text-xs">/mes</span>
                        </div>
                    </div>
                    <ul class="text-xs text-gray-300 space-y-1">
                        <li>✅ ∞ Generaciones ilimitadas</li>
                        <li>✅ Alta resolución</li>
                        <li>✅ Procesamiento prioritario</li>
                        <li>✅ Sin anuncios</li>
                        <li>✅ Soporte premium</li>
                        <li>✅ Nuevas funciones primero</li>
                    </ul>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-3">
                <button id="close-pricing-modal" class="flex-1 px-4 py-3 sm:py-2 border border-gray-600 rounded-lg text-gray-300 hover:bg-gray-700 transition text-sm">
                    Ahora no
                </button>
                <button id="upgrade-to-premium" class="flex-1 px-4 py-3 sm:py-2 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg font-semibold hover:from-purple-600 hover:to-pink-600 transition text-sm">
                    Actualizar ⚡
                </button>
            </div>

            <!-- Payment Methods Section -->
            <div class="mt-6 space-y-4" id="payment-methods" style="display: none;">
                <h3 class="text-center text-lg font-semibold text-white">Elige tu método de pago:</h3>
                
                <!-- Stripe Payment Button -->
                <button id="stripe-payment-btn" class="w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition text-sm text-white flex items-center justify-center gap-2">
                    💳 Pagar con Tarjeta (Stripe)
                </button>
                
                <!-- PayPal Payment Container -->
                <div id="paypal-button-container" class="w-full"></div>
                
                <button id="back-to-plans" class="w-full px-4 py-2 border border-gray-600 rounded-lg text-gray-300 hover:bg-gray-700 transition text-sm">
                    ← Volver a planes
                </button>
            </div>

            <p class="text-center text-xs text-gray-400 mt-4">
                Pago seguro con Stripe o PayPal • Cancela cuando quieras
            </p>
        </div>
    </div>

    <!-- Authentication Modal -->
    <div id="auth-modal" class="modal-overlay hidden fixed inset-0 flex items-center justify-center z-50 p-4">
        <div class="modal-content rounded-lg p-4 sm:p-6 max-w-sm w-full text-white max-h-[80vh] overflow-y-auto">
            <div class="text-center mb-6">
                <h2 class="text-xl font-bold mb-2">🎨 ¡Únete ahora!</h2>
                <p class="text-gray-300 text-sm">Crea una cuenta gratis para seguir generando imágenes increíbles</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Email</label>
                    <input type="email" id="auth-email" class="w-full px-3 py-3 sm:py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-indigo-400 focus:outline-none text-sm" placeholder="tu@email.com">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Nombre</label>
                    <input type="text" id="auth-name" class="w-full px-3 py-3 sm:py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-indigo-400 focus:outline-none text-sm" placeholder="Tu nombre">
                </div>
            </div>

            <div class="mt-6 space-y-3">
                <button id="register-btn" class="w-full px-4 py-3 sm:py-2 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-lg font-semibold hover:from-indigo-600 hover:to-purple-600 transition text-sm">
                    Crear Cuenta Gratis 🚀
                </button>
                
                <button id="close-auth-modal-btn" class="w-full px-4 py-3 sm:py-2 border border-gray-600 rounded-lg text-gray-300 hover:bg-gray-700 transition text-sm">
                    Ahora no
                </button>
            </div>

            <div class="mt-4 text-center">
                <p class="text-xs text-gray-400">
                    Con tu cuenta gratis obtienes <span class="text-indigo-400 font-semibold">5 generaciones diarias</span>
                </p>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const generateBtn = document.getElementById('generate-btn');
        const saveActions = document.getElementById('save-actions');
        const saveBtn = document.getElementById('save-btn'); // Botón individual
        const promptInput = document.getElementById('prompt-input');
        const rewriteBtn = document.getElementById('rewrite-btn');
        const geminiIcon = document.getElementById('gemini-icon');
        const uploadContainer = document.getElementById('upload-container');
        
        const resultContainer = document.getElementById('result-container');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('error-message');
        const saveAlbumBtn = document.getElementById('save-album-btn');
        const placeholderSlide = document.getElementById('placeholder-slide');

        // Edit Section
        const editSection = document.getElementById('edit-section');
        const editPromptInput = document.getElementById('edit-prompt-input');
        const editBtn = document.getElementById('edit-btn');
        const inpaintCancelBtn = document.getElementById('inpaint-cancel-btn');
        
        // Drawing Tools
        const toolPencil = document.getElementById('tool-pencil');
        
        // Overlay Section
        const overlaySection = document.getElementById('overlay-section');
        const uploadOverlayBtn = document.getElementById('upload-overlay-btn');
        const overlayImageUpload = document.getElementById('overlay-image-upload');
        const overlayPromptInput = document.getElementById('overlay-prompt-input');
        const implementOverlayBtn = document.getElementById('implement-overlay-btn');
        const floatingImageContainer = document.getElementById('floating-image-container');
        const floatingImage = document.getElementById('floating-image');

        // Carousel Elements
        const carousel = document.getElementById('carousel');
        const carouselTrack = document.getElementById('carousel-track');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        // Modal Elements
        const sourceModal = document.getElementById('source-modal');
        const cameraModal = document.getElementById('camera-modal');
        const drawingPromptModal = document.getElementById('drawing-prompt-modal');
        const pricingModal = document.getElementById('pricing-modal');
        const authModal = document.getElementById('auth-modal');
        const fromCameraBtn = document.getElementById('from-camera-btn');
        const fromFileBtn = document.getElementById('from-file-btn');
        const closeSourceModalBtn = document.getElementById('close-source-modal-btn');
        const closeCameraModalBtn = document.getElementById('close-camera-modal-btn');
        const captureBtn = document.getElementById('capture-btn');
        const video = document.getElementById('camera-view');
        const canvas = document.getElementById('camera-canvas');
        const maskCanvas = document.getElementById('mask-canvas');
        const maskCtx = maskCanvas.getContext('2d');
        
        // Plan & Upgrade Elements
        const planBadge = document.getElementById('plan-badge');
        const usageCount = document.getElementById('usage-count');
        const upgradeBtn = document.getElementById('upgrade-btn');
        const closePricingModal = document.getElementById('close-pricing-modal');
        const upgradeToPremium = document.getElementById('upgrade-to-premium');
        

        // --- State Variables ---
        const NUM_SLOTS = 3;
        let uploadedImagesData = new Array(NUM_SLOTS).fill(null);
        let generatedImagesHistory = [];
        let currentImageIndex = 0;
        let currentSlotIndex = null;
        let cameraStream = null;
        let isDrawing = false;
        let overlayImageData = null;

        // Drawing/Inpainting State
        let isDrawingMode = false;
        let lastPos = { x: 0, y: 0 };

        // --- Plan & Limits System ---
        let userPlan = 'free'; // 'free' or 'premium'
        let dailyUsageCount = 0;
        let maxDailyUsage = 5; // Free plan limit
        let lastUsageDate = new Date().toDateString();
        let userId = null;

        // La API Key se gestiona de forma segura en el servidor.

        // --- Plan & Limits Functions ---
        function initializePlanSystem() {
            // Load user data from localStorage
            userId = localStorage.getItem('userId') || generateUserId();
            userPlan = localStorage.getItem('userPlan') || 'free';
            dailyUsageCount = parseInt(localStorage.getItem('dailyUsageCount') || '0', 10);
            lastUsageDate = localStorage.getItem('lastUsageDate') || new Date().toDateString();
            
            // Reset daily count if it's a new day
            const today = new Date().toDateString();
            if (lastUsageDate !== today) {
                dailyUsageCount = 0;
                lastUsageDate = today;
                localStorage.setItem('dailyUsageCount', '0');
                localStorage.setItem('lastUsageDate', today);
            }
            
            // Set limits based on plan
            maxDailyUsage = userPlan === 'premium' ? Infinity : 5;
        }

        function generateUserId() {
            const id = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('userId', id);
            return id;
        }

        function updatePlanUI() {
            if (userPlan === 'premium') {
                planBadge.textContent = 'PREMIUM';
                planBadge.className = 'px-2 py-1 rounded-full plan-premium';
                usageCount.textContent = '∞ ilimitado';
                usageCount.className = 'text-purple-400';
                upgradeBtn.classList.add('hidden');
            } else {
                planBadge.textContent = 'GRATIS';
                planBadge.className = 'px-2 py-1 rounded-full plan-free';
                usageCount.textContent = `${dailyUsageCount}/${maxDailyUsage} usos`;
                
                // Change color based on usage
                if (dailyUsageCount >= maxDailyUsage) {
                    usageCount.className = 'usage-limit';
                } else if (dailyUsageCount >= maxDailyUsage - 1) {
                    usageCount.className = 'usage-warning';
                } else {
                    usageCount.className = 'text-gray-300';
                }
                
                upgradeBtn.classList.remove('hidden');
            }
        }

        function canGenerateImage() {
            return userPlan === 'premium' || dailyUsageCount < maxDailyUsage;
        }

        function consumeUsage() {
            if (userPlan === 'free') {
                dailyUsageCount++;
                localStorage.setItem('dailyUsageCount', dailyUsageCount.toString());
                updatePlanUI();
            }
        }

        function showUpgradeModal() {
            pricingModal.classList.remove('hidden');
        }

        function checkPaymentResult() {
            const urlParams = new URLSearchParams(window.location.search);
            const paymentStatus = urlParams.get('payment');
            const plan = urlParams.get('plan');
            
            if (paymentStatus === 'success' && plan === 'premium') {
                userPlan = 'premium';
                localStorage.setItem('userPlan', 'premium');
                showSuccessMessage('🎉 ¡Pago exitoso! Bienvenido a Premium con generaciones ilimitadas!');
                
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (paymentStatus === 'cancelled') {
                showError('Pago cancelado. Puedes intentar nuevamente cuando quieras.');
                
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Check for payment success from URL parameters
            checkPaymentResult();
            
            // Initialize plan system
            initializePlanSystem();
            updatePlanUI();
            createUploadSlots();
        });

        function createUploadSlots() {
            for (let i = 0; i < NUM_SLOTS; i++) {
                const slot = document.createElement('div');
                slot.className = 'upload-slot';
                slot.dataset.index = i;
                slot.innerHTML = `
                    <div class="upload-box relative flex flex-col items-center justify-center cursor-pointer rounded-lg w-20 h-20 md:w-28 md:h-28">
                        <svg class="icon h-6 w-6 mb-1 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                        <span class="text text-xs text-gray-400">Imagen ${i + 1}</span>
                        <img id="thumbnail-${i}" src="" class="hidden">
                    </div>
                    <input type="file" id="image-upload-${i}" class="hidden" accept="image/*">
                `;
                uploadContainer.appendChild(slot);

                slot.addEventListener('click', () => {
                    currentSlotIndex = i;
                    sourceModal.classList.remove('hidden');
                });
                
                const fileInput = slot.querySelector('input[type="file"]');
                fileInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => processImage(e.target.result, i);
                        reader.readAsDataURL(file);
                    }
                });
            }
        }
        createUploadSlots();


        // --- Modal & Camera Logic ---
        closeSourceModalBtn.addEventListener('click', () => sourceModal.classList.add('hidden'));
        
        fromFileBtn.addEventListener('click', () => {
            sourceModal.classList.add('hidden');
            document.getElementById(`image-upload-${currentSlotIndex}`).click();
        });

        fromCameraBtn.addEventListener('click', () => {
            sourceModal.classList.add('hidden');
            cameraModal.classList.remove('hidden');
            startCamera();
        });
        
        closeCameraModalBtn.addEventListener('click', stopCamera);

        captureBtn.addEventListener('click', () => {
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            if (video.style.transform === 'scaleX(-1)') {
                context.translate(canvas.width, 0);
                context.scale(-1, 1);
            }

            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const dataUrl = canvas.toDataURL('image/png');
            processImage(dataUrl, currentSlotIndex);
            stopCamera();
        });
        
        async function startCamera() {
            const rearCameraConstraints = { video: { facingMode: { ideal: 'environment' } } };
            const frontCameraConstraints = { video: { facingMode: 'user' } };
            
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia(rearCameraConstraints);
                video.style.transform = 'scaleX(1)';
            } catch (err) {
                try {
                    cameraStream = await navigator.mediaDevices.getUserMedia(frontCameraConstraints);
                    video.style.transform = 'scaleX(-1)';
                } catch (fallbackErr) {
                    showError("No se pudo acceder a la cámara. Revisa los permisos.");
                    stopCamera();
                    return;
                }
            }
            video.srcObject = cameraStream;
        }
        
        function stopCamera() {
            if (cameraStream) cameraStream.getTracks().forEach(track => track.stop());
            cameraModal.classList.add('hidden');
        }

        // --- Image Processing ---
        function processImage(dataUrl, index) {
            const thumbnail = document.getElementById(`thumbnail-${index}`);
            const uploadBox = thumbnail.closest('.upload-box');
            
            thumbnail.src = dataUrl;
            thumbnail.classList.remove('hidden');
            uploadBox.classList.add('has-image');
            
            const [header, base64Data] = dataUrl.split(',');
            const mimeType = header.match(/:(.*?);/)[1];
            uploadedImagesData[index] = { mimeType, data: base64Data };
            sourceModal.classList.add('hidden'); // Auto-close modal
        }

        // --- Overlay Image Logic ---
        uploadOverlayBtn.addEventListener('click', () => overlayImageUpload.click());

        overlayImageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    // Resetear todas las transformaciones
                    floatingImageContainer.style.transform = '';
                    floatingImageContainer.removeAttribute('data-x');
                    floatingImageContainer.removeAttribute('data-y'); 
                    floatingImageContainer.removeAttribute('data-rotate');
                    floatingImageContainer.removeAttribute('data-scale');
                    
                    // Configurar tamaño inicial optimizado para móviles
                    const isMobile = window.innerWidth <= 768;
                    const initialSize = isMobile ? 120 : 150;
                    floatingImageContainer.style.width = initialSize + 'px';
                    floatingImageContainer.style.height = initialSize + 'px';
                    
                    floatingImage.src = e.target.result;
                    floatingImageContainer.classList.remove('hidden');

                    // Posicionar en el centro con mejor cálculo
                    setTimeout(() => {
                        const parentRect = resultContainer.getBoundingClientRect();
                        const containerRect = floatingImageContainer.getBoundingClientRect();
                        const initialX = (parentRect.width - containerRect.width) / 2;
                        const initialY = (parentRect.height - containerRect.height) / 2;
                        
                        floatingImageContainer.setAttribute('data-x', initialX);
                        floatingImageContainer.setAttribute('data-y', initialY);
                        floatingImageContainer.setAttribute('data-scale', 1);
                        floatingImageContainer.setAttribute('data-rotate', 0);
                        updateTransform(floatingImageContainer);
                        
                        // Mostrar mensaje de ayuda
                        showFloatingImageHelp();
                    }, 100);

                    const [header, base64Data] = e.target.result.split(',');
                    overlayImageData = { mimeType: header.match(/:(.*?);/)[1], data: base64Data };
                };
                reader.readAsDataURL(file);
            }
        });

        // --- API & Generation Logic ---
        async function callApiWithBackoff(apiUrl, payload) {
            // Simplified for brevity, production code should have backoff
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Error: ${response.statusText} - ${errorData.error?.message || 'Unknown error'}`);
            }
            return await response.json();
        }

        async function handleImageGeneration(prompt, images, { mask = null, overlay = null } = {}) {
            setLoadingState(true);
            try {
                // Ahora llamamos a nuestro propio backend
                const apiUrl = '/api/generate';

                // Si hay una imagen superpuesta, el prompt se construye de forma especial
                if (overlay && overlay.image) {
                    const bgImageElement = carouselTrack.children[currentImageIndex].querySelector('img');
                    const bgWidth = bgImageElement.clientWidth;
                    const bgHeight = bgImageElement.clientHeight;

                    prompt = `Toma la primera imagen como fondo (lienzo). El tamaño del lienzo es ${bgWidth}px de ancho por ${bgHeight}px de alto.
                    Ahora, superpón la segunda imagen (la imagen flotante) sobre este lienzo.
                    - Posición de la imagen flotante (coordenadas top, left desde la esquina superior izquierda del lienzo): ${Math.round(overlay.y)}px, ${Math.round(overlay.x)}px.
                    - Tamaño de la imagen flotante: ${Math.round(overlay.width)}px de ancho por ${Math.round(overlay.height)}px de alto.
                    - Rotación de la imagen flotante: ${Math.round(overlay.rotation)} grados.
                    Finalmente, integra la imagen flotante en el fondo aplicando esta instrucción creativa: "${prompt}". La segunda imagen es la que se debe transformar y colocar; la primera es solo el lienzo.`;
                    
                    // El orden es importante: primero el fondo, luego la imagen a superponer
                    images.push(overlay.image);
                }


                const parts = [{ text: prompt }];
                images.forEach(img => parts.push({ inlineData: { mimeType: img.mimeType, data: img.data } }));
                if (mask) parts.push({ inlineData: { mimeType: mask.mimeType, data: mask.data } });
                const payload = { contents: [{ parts }] };

                const result = await callApiWithBackoff(apiUrl, payload);
                const candidate = result?.candidates?.[0];

                if (candidate && candidate.finishReason) {
                    if (candidate.finishReason === 'SAFETY') {
                        throw new Error("La combinación de imágenes fue bloqueada por motivos de seguridad.");
                    } else if (candidate.finishReason !== 'STOP') {
                        throw new Error(`Generación bloqueada. Razón: ${candidate.finishReason}`);
                    }
                }
                
                const imagePart = candidate?.content?.parts?.find(p => p.inlineData);
                if (imagePart && imagePart.inlineData.data) {
                    const mimeType = imagePart.inlineData.mimeType || 'image/png';
                    const imageUrl = `data:${mimeType};base64,${imagePart.inlineData.data}`;
                    addImageToCarousel(imageUrl);
                } else {
                    console.error("Invalid API Response:", JSON.stringify(result, null, 2));
                    throw new Error('La respuesta de la API no contiene datos de imagen válidos.');
                }
            } catch (error) {
                console.error('Failed to generate image:', error);
                showError(error.message || 'No se pudo generar la imagen.');
            } finally {
                setLoadingState(false);
            }
        }

        generateBtn.addEventListener('click', async () => {
            const prompt = promptInput.value.trim();
            const validImages = uploadedImagesData.filter(img => img !== null);
            
            // Basic validation
            if (validImages.length === 0) return showError('Por favor, sube al menos una imagen.');
            if (!prompt) return showError('Por favor, describe cómo combinar las imágenes.');
            
            // Check usage limits
            if (!canGenerateImage()) {
                showUpgradeModal();
                return;
            }

            // Consume usage and generate
            consumeUsage();
            handleImageGeneration(prompt, validImages);
        });

        editBtn.addEventListener('click', () => {
            const prompt = editPromptInput.value.trim();
            if (!prompt) return showError('Por favor, describe cómo editar la imagen.');
            if (generatedImagesHistory.length === 0) return showError('No hay imagen para editar.');

            const currentImage = generatedImagesHistory[currentImageIndex];
            const [header, base64Data] = currentImage.split(',');
            const mimeType = header.match(/:(.*?);/)[1];
            const imageData = { mimeType, data: base64Data };
            
            handleImageGeneration(prompt, [imageData]);
        }); // Fin de editBtn listener
        
        rewriteBtn.addEventListener('click', async () => {
            const validImages = uploadedImagesData.filter(img => img !== null);
            if (validImages.length === 0) {
                return showError('Sube al menos una imagen para generar una idea.');
            }

            geminiIcon.classList.add('gemini-icon-spin');
            rewriteBtn.disabled = true;
            try {
                // Ahora llamamos a nuestro propio backend
                const apiUrl = '/api/generate';
                
                const parts = [{ text: "Observa las siguientes imágenes. Genera un prompt creativo y descriptivo para combinarlas en una sola imagen. Devuelve únicamente el texto del prompt, sin explicaciones ni introducciones." }];
                validImages.forEach(img => parts.push({ inlineData: { mimeType: img.mimeType, data: img.data } }));

                const payload = {
                    contents: [{
                        parts: parts
                    }]
                };
                const result = await callApiWithBackoff(apiUrl, payload);
                const newPrompt = result.candidates[0].content.parts[0].text.trim();
                promptInput.value = newPrompt.replace(/\"/g, ''); // Limpia comillas
            } catch (error) {
                console.error('Error reescribiendo el prompt:', error);
                showError('No se pudo mejorar el prompt.');
            } finally {
                geminiIcon.classList.remove('gemini-icon-spin');
                rewriteBtn.disabled = false;
            }
        });

        implementOverlayBtn.addEventListener('click', async () => {
            const prompt = overlayPromptInput.value.trim();
            if (!prompt) return showError('Describe cómo implementar la imagen flotante.');
            if (!overlayImageData) return showError('Carga una imagen flotante primero.');
            if (generatedImagesHistory.length === 0) return showError('No hay imagen de fondo para editar.');

            // Get base image
            const currentImage = generatedImagesHistory[currentImageIndex];
            const [header, base64Data] = currentImage.split(',');
            const baseImage = { mimeType: header.match(/:(.*?);/)[1], data: base64Data };

            // Get overlay image and its transformations
            const overlay = {
                image: overlayImageData,
                x: parseFloat(floatingImageContainer.dataset.x || 0),
                y: parseFloat(floatingImageContainer.dataset.y || 0),
                width: floatingImageContainer.clientWidth,
                height: floatingImageContainer.clientHeight,
                rotation: parseFloat(floatingImageContainer.dataset.rotate || 0),
                scale: parseFloat(floatingImageContainer.dataset.scale || 1)
            };
            
            await handleImageGeneration(prompt, [baseImage], { overlay });

            // Hide and reset the floating image after generation is complete
            floatingImageContainer.classList.add('hidden');
            floatingImage.src = '';
            overlayImageData = null;
            overlayPromptInput.value = ''; // Borra el texto del prompt
            floatingImageContainer.style.transform = '';
            floatingImageContainer.removeAttribute('data-x');
            floatingImageContainer.removeAttribute('data-y');
            floatingImageContainer.removeAttribute('data-rotate');
            floatingImageContainer.removeAttribute('data-scale');
        });

        // --- Carousel Logic ---
        function addImageToCarousel(imageUrl) {
            generatedImagesHistory.push(imageUrl);
            
            if (placeholderSlide.parentElement) {
                carouselTrack.removeChild(placeholderSlide);
            }

            const slide = document.createElement('div');
            slide.className = 'carousel-slide';
            slide.innerHTML = `<img src="${imageUrl}" class="max-w-full max-h-[512px] h-full rounded-md object-contain">`;
            carouselTrack.appendChild(slide);

            currentImageIndex = generatedImagesHistory.length - 1;
            updateCarousel();
            editPromptInput.value = ''; // Clear edit prompt
        }

        function updateCarousel() {
            carouselTrack.style.transform = `translateX(-${currentImageIndex * 100}%)`;
            
            // Show/hide nav buttons
            prevBtn.classList.toggle('hidden', currentImageIndex === 0);
            nextBtn.classList.toggle('hidden', currentImageIndex === generatedImagesHistory.length - 1);
            
            // Show/hide save buttons and edit section
            const hasImages = generatedImagesHistory.length > 0;
            saveActions.classList.toggle('hidden', !hasImages);
            editSection.classList.toggle('hidden', !hasImages && !isDrawingMode);
            overlaySection.classList.toggle('hidden', !hasImages && !isDrawingMode);
            saveAlbumBtn.classList.toggle('hidden', generatedImagesHistory.length < 2);
            
            if (isDrawingMode || isDrawing) {
                deactivateDrawingMode();
            }
        }

        saveAlbumBtn.addEventListener('click', async () => {
            if (generatedImagesHistory.length < 2) return;

            setLoadingState(true); // Muestra el loader
            try {
                const zip = new JSZip();
                generatedImagesHistory.forEach((dataUrl, index) => {
                    const base64Data = dataUrl.split(',')[1];
                    zip.file(`imagen-generada-${index + 1}.png`, base64Data, { base64: true });
                });

                const content = await zip.generateAsync({ type: 'blob' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = 'album-imagenes-generadas.zip';
                link.click();
                URL.revokeObjectURL(link.href);
            } catch (error) {
                console.error("Error creando el archivo zip:", error);
                showError("No se pudo crear el álbum.");
            } finally {
                setLoadingState(false); // Oculta el loader
            }
        });

        prevBtn.addEventListener('click', () => {
            if (currentImageIndex > 0) {
                currentImageIndex--;
                updateCarousel();
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentImageIndex < generatedImagesHistory.length - 1) {
                currentImageIndex++;
                updateCarousel();
            }
        });
        
        let touchstartX = 0;
        let touchendX = 0;

        carousel.addEventListener('touchstart', e => { touchstartX = e.changedTouches[0].screenX }, { passive: true });
        carousel.addEventListener('touchend', e => {
            touchendX = e.changedTouches[0].screenX;
            if (touchendX < touchstartX - 50) nextBtn.click();
            if (touchendX > touchstartX + 50) prevBtn.click();
        });

        // --- UI Helper Functions ---
        saveBtn.addEventListener('click', () => {
            if (generatedImagesHistory.length > 0) {
                 const link = document.createElement('a');
                 link.href = generatedImagesHistory[currentImageIndex];
                 link.download = `imagen-generada-${currentImageIndex + 1}.png`;
                 link.click();
            }
        });

        function setLoadingState(isLoading) {
            hideError();
            loader.classList.toggle('hidden', !isLoading);
            if(generateBtn) generateBtn.disabled = isLoading;
            editBtn.disabled = isLoading;
            implementOverlayBtn.disabled = isLoading;
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function hideError() {
            errorMessage.classList.add('hidden');
        }

        // Add listeners for drawing tools
        toolPencil.addEventListener('click', activateDrawingMode);
        inpaintCancelBtn.addEventListener('click', deactivateDrawingMode);
        // Drawing mode functions
        function activateDrawingMode() {
            if (generatedImagesHistory.length === 0) {
                showError('Primero genera una imagen para poder dibujar sobre ella.');
                return;
            }
            
            isDrawingMode = true;
            editBtn.classList.add('hidden'); // Hide general edit button
            inpaintCancelBtn.classList.remove('hidden'); // Show cancel button
            overlaySection.classList.add('hidden');
            
            // Show helper message
            showError(`✏️ Modo Lápiz Activo. Dibuja o encierra el área que quieres cambiar. El trazo será más preciso.`);
            setTimeout(() => hideError(), 6000);
            
            // Highlight the active tool
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('bg-indigo-500'));
            document.getElementById('tool-pencil').classList.add('bg-indigo-500');
            
            // Set cursor for the result container
            resultContainer.style.cursor = 'crosshair';
            
            // Make sure the result container can receive mouse events
            resultContainer.style.pointerEvents = 'auto';
            setupMaskCanvas();
        }

        function deactivateDrawingMode() {
            isDrawingMode = false;
            isDrawing = false;
            editBtn.classList.remove('hidden');
            inpaintCancelBtn.classList.add('hidden');
            if (generatedImagesHistory.length > 0) overlaySection.classList.remove('hidden');

            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('bg-indigo-500'));
            resultContainer.style.cursor = 'default';
            resultContainer.style.pointerEvents = 'auto';
            
            // Clear and hide mask canvas
            if (!maskCanvas.classList.contains('hidden')) {
                maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
                maskCanvas.classList.add('hidden');
            }
            
            // Show message
            hideError();
            showError('✅ Modo dibujo desactivado.');
            setTimeout(() => hideError(), 3000);
        }

        function showDrawingPromptPopup() {
            drawingPromptModal.classList.remove('hidden');
            document.getElementById('drawing-prompt-textarea').focus();
        }

        document.getElementById('drawing-prompt-apply').addEventListener('click', async () => {
            const prompt = document.getElementById('drawing-prompt-textarea').value.trim();
            if (!prompt) {
                showError('Por favor describe el cambio que quieres hacer.');
                return;
            }
            drawingPromptModal.classList.add('hidden');
            await applyDrawingChange(prompt);
        });

        document.getElementById('drawing-prompt-cancel').addEventListener('click', () => {
            drawingPromptModal.classList.add('hidden');
            // If the user cancels pencil drawing, clear the mask to avoid confusion
            if (!maskCanvas.classList.contains('hidden')) {
                maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
            }
        });

        drawingPromptModal.addEventListener('click', (e) => {
            if (e.target === drawingPromptModal) {
                document.getElementById('drawing-prompt-cancel').click();
            }
        });
        async function applyDrawingChange(prompt) {
            let maskData;

            const maskDataUrl = maskCanvas.toDataURL('image/png');
            const [maskHeader, maskBase64Data] = maskDataUrl.split(',');
            maskData = { mimeType: maskHeader.match(/:(.*?);/)[1], data: maskBase64Data };
            
            await performInpaint(prompt, maskData);
        }

        async function performInpaint(prompt, maskData) {
            const currentImage = generatedImagesHistory[currentImageIndex];
            const [header, base64Data] = currentImage.split(',');
            const imageData = { mimeType: header.match(/:(.*?);/)[1], data: base64Data };
            
            await handleImageGeneration(prompt, [imageData], { mask: maskData });
            
            deactivateDrawingMode();
        }

        function setupMaskCanvas() {
            const currentImageElement = carouselTrack.children[currentImageIndex]?.querySelector('img');
            if (!currentImageElement) return;

            const rect = currentImageElement.getBoundingClientRect();
            const containerRect = resultContainer.getBoundingClientRect();

            maskCanvas.width = currentImageElement.naturalWidth;
            maskCanvas.height = currentImageElement.naturalHeight;
            maskCanvas.style.width = rect.width + 'px';
            maskCanvas.style.height = rect.height + 'px';
            maskCanvas.style.left = (rect.left - containerRect.left) + 'px';
            maskCanvas.style.top = (rect.top - containerRect.top) + 'px';
            maskCanvas.classList.remove('hidden');

            maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
            maskCtx.strokeStyle = 'rgba(255, 255, 255, 0.9)';
            maskCtx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            maskCtx.lineWidth = 6; // Lápiz más fino para mayor precisión
            maskCtx.lineCap = 'round';
            maskCtx.lineJoin = 'round';
            maskCtx.shadowColor = 'rgba(0, 0, 0, 0.7)';
            maskCtx.shadowBlur = 1;
        }

        function getEventCoordinates(e) {
            if (e.touches && e.touches.length > 0) {
                return { clientX: e.touches[0].clientX, clientY: e.touches[0].clientY };
            }
            return { clientX: e.clientX, clientY: e.clientY };
        }

        function handleDrawStart(e) {
            if (!isDrawingMode || e.target.closest('.carousel-btn') || e.target.closest('#floating-image-container')) return;

            const currentImageElement = carouselTrack.children[currentImageIndex]?.querySelector('img');
            if (!currentImageElement) return;

            isDrawing = true;
            const coords = getEventCoordinates(e);
            const rect = resultContainer.getBoundingClientRect();

            const maskRect = maskCanvas.getBoundingClientRect();
            lastPos = {
                x: (coords.clientX - maskRect.left) * (maskCanvas.width / maskRect.width),
                y: (coords.clientY - maskRect.top) * (maskCanvas.height / maskRect.height)
            };

            e.preventDefault(); // Prevent default behavior
        }

        function handleDrawMove(e) {
            if (!isDrawing) return;
            const coords = getEventCoordinates(e);

            const maskRect = maskCanvas.getBoundingClientRect();
            const currentPos = {
                x: (coords.clientX - maskRect.left) * (maskCanvas.width / maskRect.width),
                y: (coords.clientY - maskRect.top) * (maskCanvas.height / maskRect.height)
            };

            // Dibujar línea suave entre la posición anterior y actual
            maskCtx.beginPath();
            maskCtx.moveTo(lastPos.x, lastPos.y);
            maskCtx.lineTo(currentPos.x, currentPos.y);
            maskCtx.stroke();

            // También dibujar un círculo en la posición actual para mejor cobertura
            maskCtx.beginPath();
            maskCtx.arc(currentPos.x, currentPos.y, maskCtx.lineWidth / 2, 0, 2 * Math.PI);
            maskCtx.fill();

            lastPos = currentPos;
            e.preventDefault(); // Prevenir comportamiento por defecto
        }

        function handleDrawEnd() {
            if (!isDrawing) return;
            isDrawing = false;
            showDrawingPromptPopup();
        }

        // Mouse and Touch event listeners
        resultContainer.addEventListener('mousedown', handleDrawStart);
        document.addEventListener('mousemove', handleDrawMove);
        document.addEventListener('mouseup', handleDrawEnd);

        resultContainer.addEventListener('touchstart', handleDrawStart, { passive: false });
        document.addEventListener('touchmove', handleDrawMove, { passive: false });
        document.addEventListener('touchend', handleDrawEnd);

        // Add escape key to exit drawing mode
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && isDrawingMode) {
                deactivateDrawingMode();
            }
        });

        // --- Enhanced Floating Image Controls ---
        let floatingImageState = {
            x: 0,
            y: 0,
            rotation: 0,
            scale: 1,
            width: 150,
            height: 150
        };

        // Variables para gestos táctiles
        let touchStartDistance = 0;
        let touchStartScale = 1;
        let isGesturing = false;

        function updateTransform(target) {
            const x = parseFloat(target.getAttribute('data-x')) || 0;
            const y = parseFloat(target.getAttribute('data-y')) || 0;
            const angle = parseFloat(target.getAttribute('data-rotate')) || 0;
            const scale = parseFloat(target.getAttribute('data-scale')) || 1;
            target.style.transform = `translate(${x}px, ${y}px) rotate(${angle}deg) scale(${scale})`;
        }

        function updateFloatingImageSize(width, height) {
            floatingImageContainer.style.width = Math.max(50, Math.min(width, window.innerWidth * 0.9)) + 'px';
            floatingImageContainer.style.height = Math.max(50, Math.min(height, window.innerHeight * 0.9)) + 'px';
        }

        // Función para calcular distancia entre dos puntos táctiles
        function getDistance(touch1, touch2) {
            const dx = touch1.clientX - touch2.clientX;
            const dy = touch1.clientY - touch2.clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }

        // Configurar interact.js para arrastrar
        interact(floatingImageContainer).draggable({
            listeners: {
                start(event) {
                    event.target.classList.add('active');
                },
                move(event) {
                    if (isGesturing) return; // No mover si está haciendo gestos de pellizco
                    
                    const target = event.target;
                    const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
                    const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
                    target.setAttribute('data-x', x);
                    target.setAttribute('data-y', y);
                    updateTransform(target);
                },
                end(event) {
                    event.target.classList.remove('active');
                }
            },
            inertia: true,
            modifiers: [
                interact.modifiers.restrictRect({
                    restriction: 'parent',
                    endOnly: true
                })
            ]
        });

        // Manejar gestos táctiles (pellizco para escalar)
        floatingImageContainer.addEventListener('touchstart', function(e) {
            if (e.touches.length === 2) {
                e.preventDefault();
                isGesturing = true;
                touchStartDistance = getDistance(e.touches[0], e.touches[1]);
                touchStartScale = parseFloat(this.getAttribute('data-scale')) || 1;
                this.classList.add('active');
            }
        }, { passive: false });

        floatingImageContainer.addEventListener('touchmove', function(e) {
            if (e.touches.length === 2 && isGesturing) {
                e.preventDefault();
                const currentDistance = getDistance(e.touches[0], e.touches[1]);
                const scale = touchStartScale * (currentDistance / touchStartDistance);
                
                // Limitar el escalado entre 0.3 y 3
                const clampedScale = Math.max(0.3, Math.min(3, scale));
                this.setAttribute('data-scale', clampedScale);
                updateTransform(this);
            }
        }, { passive: false });

        floatingImageContainer.addEventListener('touchend', function(e) {
            if (e.touches.length < 2) {
                isGesturing = false;
                this.classList.remove('active');
            }
        });

        // Handle de redimensionado
        interact('#resize-handle').draggable({
            onstart: function(event) {
                floatingImageContainer.classList.add('active');
            },
            onmove: function (event) {
                const target = floatingImageContainer;
                const rect = target.getBoundingClientRect();
                const newWidth = rect.width + event.dx;
                const newHeight = rect.height + event.dy;
                updateFloatingImageSize(newWidth, newHeight);
            },
            onend: function(event) {
                floatingImageContainer.classList.remove('active');
            }
        });

        // Handle de escalado proporcional
        interact('#scale-handle').draggable({
            onstart: function(event) {
                floatingImageContainer.classList.add('active');
            },
            onmove: function (event) {
                const target = floatingImageContainer;
                const rect = target.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                // Calcular escala basada en la distancia del centro
                const currentScale = parseFloat(target.getAttribute('data-scale')) || 1;
                const scaleDelta = (event.dx + event.dy) * 0.005;
                const newScale = Math.max(0.3, Math.min(3, currentScale + scaleDelta));
                
                target.setAttribute('data-scale', newScale);
                updateTransform(target);
            },
            onend: function(event) {
                floatingImageContainer.classList.remove('active');
            }
        });

        // Handle de rotación mejorado
        interact('#rotate-handle').draggable({
            onstart: function(event) {
                floatingImageContainer.classList.add('active');
            },
            onmove: function (event) {
                const target = floatingImageContainer;
                const rect = target.getBoundingClientRect();
                const center = { 
                    x: rect.left + rect.width / 2, 
                    y: rect.top + rect.height / 2 
                };
                
                const angle = Math.atan2(event.clientY - center.y, event.clientX - center.x);
                const newAngleDeg = (angle * (180 / Math.PI)) + 90;
                
                target.setAttribute('data-rotate', newAngleDeg);
                updateTransform(target);
            },
            onend: function(event) {
                floatingImageContainer.classList.remove('active');
            }
        });

        // Doble tap para resetear transformaciones
        let lastTap = 0;
        floatingImageContainer.addEventListener('touchend', function(e) {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;
            if (tapLength < 500 && tapLength > 0) {
                // Doble tap detectado - resetear transformaciones
                this.setAttribute('data-x', 0);
                this.setAttribute('data-y', 0);
                this.setAttribute('data-rotate', 0);
                this.setAttribute('data-scale', 1);
                updateTransform(this);
                updateFloatingImageSize(150, 150);
                
                // Mostrar feedback visual
                this.style.boxShadow = '0 0 20px rgba(34, 197, 94, 0.6)';
                setTimeout(() => {
                    this.style.boxShadow = '';
                }, 500);
            }
            lastTap = currentTime;
        });

        // Función para mostrar ayuda sobre imagen flotante
        function showFloatingImageHelp() {
            const helpMessage = document.createElement('div');
            helpMessage.id = 'floating-help';
            helpMessage.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0,0,0,0.9);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 1000;
                max-width: 90%;
                text-align: center;
                border: 1px solid rgba(99, 102, 241, 0.5);
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            
            const isMobile = window.innerWidth <= 768;
            helpMessage.innerHTML = isMobile ? 
                `✨ <strong>Imagen flotante cargada</strong><br>
                • Arrastra para mover<br>
                • Pellizca para escalar<br>
                • Usa los botones para rotar/redimensionar<br>
                • Doble tap para resetear` :
                `✨ <strong>Imagen flotante cargada</strong><br>
                Arrastra para mover • Usa los controles para escalar/rotar • Doble clic para resetear`;
            
            document.body.appendChild(helpMessage);
            
            // Auto-ocultar después de 4 segundos
            setTimeout(() => {
                if (helpMessage.parentNode) {
                    helpMessage.style.opacity = '0';
                    helpMessage.style.transition = 'opacity 0.3s ease';
                    setTimeout(() => helpMessage.remove(), 300);
                }
            }, 4000);
        }

        // Mejorar feedback visual en controles
        document.querySelectorAll('.interaction-handle').forEach(handle => {
            handle.addEventListener('mousedown', () => {
                handle.style.transform = 'scale(1.2)';
                handle.style.boxShadow = '0 0 12px rgba(99, 102, 241, 0.6)';
            });
            
            handle.addEventListener('mouseup', () => {
                handle.style.transform = '';
                handle.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';
            });
        });

        // --- Plan & Upgrade Event Listeners ---
        upgradeBtn.addEventListener('click', () => {
            showUpgradeModal();
        });

        closePricingModal.addEventListener('click', () => {
            pricingModal.classList.add('hidden');
        });

        upgradeToPremium.addEventListener('click', () => {
            // Mostrar opciones de pago
            document.querySelector('.space-y-4').style.display = 'none';
            document.querySelector('.flex.flex-col.sm\\:flex-row.gap-3').style.display = 'none';
            document.getElementById('payment-methods').style.display = 'block';
            
            // Inicializar PayPal
            initializePayPal();
        });

        // Click outside modal to close
        pricingModal.addEventListener('click', (e) => {
            if (e.target === pricingModal) {
                pricingModal.classList.add('hidden');
            }
        });

        authModal.addEventListener('click', (e) => {
            if (e.target === authModal) {
                authModal.classList.add('hidden');
            }
        });

        // Auth Modal Event Listeners
        document.getElementById('close-auth-modal-btn').addEventListener('click', () => {
            authModal.classList.add('hidden');
        });

        document.getElementById('register-btn').addEventListener('click', () => {
            const email = document.getElementById('auth-email').value.trim();
            const name = document.getElementById('auth-name').value.trim();
            
            if (email && name) {
                localStorage.setItem('userEmail', email);
                localStorage.setItem('userName', name);
                localStorage.setItem('userIsRegistered', 'true');
                
                authModal.classList.add('hidden');
                showSuccessMessage('¡Registro exitoso! Ahora tienes acceso a más generaciones.');
            } else {
                showError('Por favor completa todos los campos.');
            }
        });

        // Payment method event listeners
        document.getElementById('stripe-payment-btn').addEventListener('click', async () => {
            const success = await processStripePayment();
            if (success) {
                completePurchase();
            } else {
                showError('Error en el pago con Stripe. Intenta nuevamente.');
            }
        });

        document.getElementById('back-to-plans').addEventListener('click', () => {
            document.querySelector('.space-y-4').style.display = 'block';
            document.querySelector('.flex.flex-col.sm\\:flex-row.gap-3').style.display = 'flex';
            document.getElementById('payment-methods').style.display = 'none';
        });

        async function processStripePayment() {
            try {
                // Initialize Stripe (replace with your publishable key)
                const stripe = Stripe('pk_test_51xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx');
                
                // Create checkout session
                const response = await fetch('/api/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        priceId: 'price_premium_monthly', // Your Stripe price ID
                        userId: userId,
                        plan: 'premium'
                    })
                });
                
                const session = await response.json();
                
                if (session.url) {
                    // Redirect to Stripe checkout
                    window.location.href = session.url;
                    return true;
                } else {
                    console.error('Error creating checkout session:', session.error);
                    return false;
                }
            } catch (error) {
                console.error('Stripe payment error:', error);
                return false;
            }
        }

        async function initializePayPal() {
            try {
                // Get PayPal configuration from server
                const configResponse = await fetch('/api/paypal/config');
                const config = await configResponse.json();
                
                // Load PayPal SDK dynamically
                if (!window.paypal) {
                    await loadPayPalSDK(config.clientId);
                }
                
                // Clear any existing PayPal buttons
                document.getElementById('paypal-button-container').innerHTML = '';
                
                paypal.Buttons({
                createOrder: async function(data, actions) {
                    try {
                        const response = await fetch('/api/paypal/create-order', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                amount: '9.99',
                                currency: 'USD',
                                userId: userId,
                                plan: 'premium'
                            })
                        });
                        
                        const orderData = await response.json();
                        return orderData.orderID;
                    } catch (error) {
                        console.error('Error creating PayPal order:', error);
                        showError('Error creando orden de PayPal');
                    }
                },
                onApprove: async function(data, actions) {
                    try {
                        const response = await fetch('/api/paypal/capture-order', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                orderID: data.orderID
                            })
                        });
                        
                        const captureData = await response.json();
                        
                        if (captureData.success) {
                            completePurchase();
                        } else {
                            showError('Error procesando el pago de PayPal');
                        }
                    } catch (error) {
                        console.error('Error capturing PayPal payment:', error);
                        showError('Error procesando el pago de PayPal');
                    }
                },
                onError: function(err) {
                    console.error('PayPal error:', err);
                    showError('Error con PayPal. Intenta nuevamente.');
                },
                style: {
                    color: 'blue',
                    shape: 'rect',
                    label: 'paypal',
                    layout: 'vertical'
                }
            }).render('#paypal-button-container');
            } catch (error) {
                console.error('Error initializing PayPal:', error);
                showError('Error cargando PayPal. Intenta refrescar la página.');
            }
        }

        function loadPayPalSDK(clientId) {
            return new Promise((resolve, reject) => {
                if (window.paypal) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = `https://www.paypal.com/sdk/js?client-id=${clientId}&currency=USD`;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        function completePurchase() {
            userPlan = 'premium';
            localStorage.setItem('userPlan', 'premium');
            updatePlanUI();
            pricingModal.classList.add('hidden');
            
            // Reset modal state
            document.querySelector('.space-y-4').style.display = 'block';
            document.querySelector('.flex.flex-col.sm\\:flex-row.gap-3').style.display = 'flex';
            document.getElementById('payment-methods').style.display = 'none';
            
            showSuccessMessage('🎉 ¡Bienvenido a Premium! Ahora tienes generaciones ilimitadas.');
        }

        function showSuccessMessage(message) {
            const errorEl = document.getElementById('error-message');
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.style.color = '#10b981'; // Green color
                errorEl.classList.remove('hidden');
                setTimeout(() => {
                    errorEl.classList.add('hidden');
                    errorEl.style.color = '#ef4444'; // Reset to red
                }, 4000);
            }
        }
    </script>
</body>
</html>
